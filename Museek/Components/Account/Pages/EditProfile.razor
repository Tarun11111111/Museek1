@page "/editprofile"
@using Microsoft.AspNetCore.Identity
@using Museek.Data
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IServiceScopeFactory ScopeFactory

<PageTitle>Museek | Edit Profile (Diagnostic)</PageTitle>

<div class="account-wrapper">
    <div class="account-container">
        <div class="header-section">
            <h1>Edit Profile (Diagnostic)</h1>
            <p style="color: yellow;">Please change your name to something unique (e.g., "TarunTEST") to ensure the database sees a change.</p>
        </div>

        <div class="content-card">
            <EditForm Model="Input" OnValidSubmit="UpdateUserDiagnostic" FormName="edit-profile-diag">
                <DataAnnotationsValidator />

                <div class="form-grid">
                    <div class="form-group">
                        <label>First Name</label>
                        <InputText @bind-Value="Input.FirstName" class="form-input" />
                    </div>

                    <div class="form-group">
                        <label>Last Name</label>
                        <InputText @bind-Value="Input.LastName" class="form-input" />
                    </div>

                    <div class="form-group full-width">
                        <label>Phone Number</label>
                        <InputText @bind-Value="Input.PhoneNumber" class="form-input" />
                    </div>
                </div>

                @if (rowsAffected > 0)
                {
                    <div class="alert success">
                        <strong>SUCCESS:</strong> Rows Written: @rowsAffected <br />
                        The database confirmed it changed data.
                        <button class="btn-link" @onclick="GoBack">Return to Account</button>
                    </div>
                }
                else if (saveAttempted && rowsAffected == 0)
                {
                    <div class="alert error">
                        <strong>WARNING: Rows Written: 0</strong><br />
                        The database saw no changes. Did you type the exact same name?
                    </div>
                }

                @if (saveError != null)
                {
                    <div class="alert error">
                        <strong>ERROR:</strong> @saveError
                    </div>
                }

                <div class="action-bar">
                    <button type="submit" class="btn-primary">Save Changes</button>
                    <a href="/account" class="btn-secondary">Cancel</a>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private InputModel Input { get; set; } = new();
    private string? saveError;
    private string? currentUserId;
    private int rowsAffected = 0;
    private bool saveAttempted = false;

    private class InputModel
    {
        [Required] public string? FirstName { get; set; }
        [Required] public string? LastName { get; set; }
        [Phone] public string? PhoneNumber { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        if (userPrincipal.Identity?.IsAuthenticated == true)
        {
            currentUserId = userPrincipal.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (currentUserId != null)
            {
                using (var scope = ScopeFactory.CreateScope())
                {
                    var context = scope.ServiceProvider.GetRequiredService<MuseekContext>();
                    var user = await context.Users.AsNoTracking().FirstOrDefaultAsync(u => u.Id == currentUserId);
                    if (user != null)
                    {
                        Input.FirstName = user.FirstName;
                        Input.LastName = user.LastName;
                        Input.PhoneNumber = user.PhoneNumber;
                    }
                }
            }
        }
    }

    private async Task UpdateUserDiagnostic()
    {
        saveAttempted = true;
        rowsAffected = 0;
        saveError = null;

        if (string.IsNullOrEmpty(currentUserId)) return;

        try
        {
            using (var scope = ScopeFactory.CreateScope())
            {
                var context = scope.ServiceProvider.GetRequiredService<MuseekContext>();

                // 1. Fetch User
                var userToUpdate = await context.Users.FirstOrDefaultAsync(u => u.Id == currentUserId);

                if (userToUpdate != null)
                {
                    // 2. Modify Properties
                    userToUpdate.FirstName = Input.FirstName;
                    userToUpdate.LastName = Input.LastName;
                    userToUpdate.PhoneNumber = Input.PhoneNumber;

                    // 3. Force Entity State to Modified (Just in case)
                    context.Entry(userToUpdate).State = EntityState.Modified;

                    // 4. Save and Capture Count
                    rowsAffected = await context.SaveChangesAsync();
                }
                else
                {
                    saveError = "User ID not found in DB table.";
                }
            }
        }
        catch (Exception ex)
        {
            saveError = "DB Error: " + ex.Message;
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/account", forceLoad: true);
    }
}

<style>
    /* Reuse styles */
    .account-wrapper {
        display: flex;
        justify-content: center;
        padding: 40px 20px;
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .account-container {
        width: 100%;
        max-width: 700px;
    }

    .header-section {
        margin-bottom: 25px;
    }

    h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 5px;
    }

    p {
        color: #b3b3b3;
        font-size: 1rem;
    }

    .content-card {
        background-color: #181818;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        border: 1px solid #282828;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .full-width {
        grid-column: span 2;
    }

    .form-group label {
        display: block;
        color: #ccc;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        background-color: #121212;
        border: 1px solid #444;
        border-radius: 8px;
        color: white;
        font-size: 1rem;
        box-sizing: border-box;
    }

    .btn-primary {
        background-color: #fff;
        color: #000;
        border: none;
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 700;
        cursor: pointer;
    }

    .btn-secondary {
        color: #ccc;
        margin-left: 15px;
        text-decoration: none;
    }

    .btn-link {
        background: none;
        border: none;
        color: #2ecc71;
        text-decoration: underline;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
    }

    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid transparent;
    }

        .alert.success {
            background: rgba(40, 167, 69, 0.2);
            color: #2ecc71;
            border-color: #2ecc71;
        }

        .alert.error {
            background: rgba(220, 53, 69, 0.2);
            color: #ff5252;
            border-color: #ff5252;
        }
</style>