@page "/playlists"
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@inject IDbContextFactory<Museek.Data.MuseekContext> DbFactory
@using Microsoft.AspNetCore.Components.QuickGrid
@rendermode InteractiveServer

<PageTitle>Index</PageTitle>

<h1>Index</h1>

<p>
    <a href="playlists/create">Create New</a>
</p>

@if (playlists == null)
{
    <p><em>Loading...</em></p>
}
else
{


    <QuickGrid Class="table" Items="FilteredPlaylists" Pagination="paginationState">
        <PropertyColumn Property="playlist => playlist.Name" Sortable="true" />
        <PropertyColumn Property="playlist => playlist.Description" />
        <PropertyColumn Property="playlist => playlist.Cover_Image" />

        <TemplateColumn Context="playlist" Title="User">
            @GetUserString(playlist.UserId)
        </TemplateColumn>


        @* <PropertyColumn Property="playlist => playlist.UserId" /> *@

        @* <PropertyColumn Property="playlist => playlist.DateCreated" />
        <PropertyColumn Property="playlist => playlist.DateUpdated" />
        <PropertyColumn Property="playlist => playlist.CreatedBy" />
        <PropertyColumn Property="playlist => playlist.UpdatedBy" /> *@

        <TemplateColumn Context="playlist">
            <a href="@($"playlists/edit?id={playlist.Id}")">Edit</a> |
            <a href="@($"playlists/details?id={playlist.Id}")">Details</a> |
            <a href="@($"playlists/delete?id={playlist.Id}")">Delete</a>
        </TemplateColumn>


    </QuickGrid>
    <Paginator State="paginationState" />

}

@code {

    PaginationState paginationState = new PaginationState { ItemsPerPage = 1 };

    //Declare and initialize IList and Dictionaries
    private IList<User> Users;


    private MuseekContext context = default!;
    private string userId = string.Empty;
    private bool isAdmin = false;
    @inject AuthenticationStateProvider authenticationStateProvider

    // Filter bookings by userId
    private IQueryable<Playlist> FilteredPlaylists => isAdmin
    ? context.Playlist // Admins can see all bookings
    : context.Playlist.Where(e => e.CreatedBy == userId); // Regular users see only their own bookings

    private List<Playlist>? playlists;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        // Extract user information
        userId = user.FindFirst("userId")?.Value ?? string.Empty;
        isAdmin = user.IsInRole("Administrator");

        using var context = DbFactory.CreateDbContext();



        playlists = await context.Playlist.ToListAsync();
    }

    // GetUserString method to get the vehicle string 
    private string GetUserString(int userId) 
    { 
        var user = Users.FirstOrDefault(v => v.Id == userId);
        return user == null ? string.Empty : $"{user.Name} ({user.Email})";
    } 





}