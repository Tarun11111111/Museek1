@page "/albums"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Museek.Domain
@using Museek.Data
@inject IDbContextFactory<MuseekContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Albums</PageTitle>

<div class="library-page">
    <div class="page-head">
        <div class="head-left">
            <div class="page-title">@PageTitleText</div>
            <div class="page-sub">@PageSubText</div>
        </div>

        <div class="head-actions">
            @if (isAdmin)
            {
                <a class="btn" href="@CreateHref">+ New Album</a>
            }

            <a class="btn" href="@BackHref">Back</a>
        </div>
    </div>

    <div class="top-actions">
        <div class="search-bar">
            <img src="images/search.png" class="search-icon" />
            <input type="text" placeholder="Search albums" @bind="searchText" />
        </div>
    </div>

    @if (loading)
    {
        <div class="empty-row">Loading...</div>
    }
    else if (!FilteredAlbums.Any())
    {
        <div class="empty-row">No albums found.</div>
    }
    else
    {
        <div class="album-grid">
            @foreach (var a in FilteredAlbums)
            {
                <a class="album-card" href="@($"/albums/details?id={a.Id}")">
                    <img class="album-img"
                         src="@(!string.IsNullOrWhiteSpace(a.Cover_Image) ? a.Cover_Image : "images/default-cover.jpg")" />
                    <div class="album-meta">
                        <div class="album-title">@a.Title</div>
                        <div class="album-sub">
                            @GetArtistName(a.ArtistId)
                            @if (a.ReleasedDate.HasValue)
                            {
                                <span class="dot">•</span>
                                <span>@a.ReleasedDate.Value.ToString("dd MMM yyyy")</span>
                            }
                        </div>
                    </div>
                </a>
            }
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery] private int? ArtistId { get; set; }

    private bool loading = true;
    private bool isAdmin = false;

    private string searchText = "";

    private List<Album> albums = new();
    private List<Artist> artists = new();

    private string artistName = "";

    private string PageTitleText =>
        string.IsNullOrWhiteSpace(artistName) ? "Albums" : $"Albums. {artistName}";

    private string PageSubText =>
        isAdmin
            ? "Create and manage albums. Add songs inside an album."
            : "Browse albums and play songs.";

    private string BackHref => isAdmin ? "/artists" : "/artists";

    private string CreateHref =>
        ArtistId.HasValue ? $"/albums/create?artistId={ArtistId.Value}" : "/albums/create";

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Administrator");

        artists = await db.Artist.AsNoTracking().ToListAsync();

        IQueryable<Album> q = db.Album.AsNoTracking();

        if (ArtistId.HasValue && ArtistId.Value > 0)
        {
            q = q.Where(a => a.ArtistId == ArtistId.Value);
            artistName = GetArtistName(ArtistId.Value);
        }

        albums = await q
            .OrderByDescending(a => a.DateCreated)
            .ToListAsync();

        loading = false;
    }

    private IEnumerable<Album> FilteredAlbums =>
        string.IsNullOrWhiteSpace(searchText)
            ? albums
            : albums.Where(a =>
                (a.Title ?? "").Contains(searchText.Trim(), StringComparison.OrdinalIgnoreCase)
                || GetArtistName(a.ArtistId).Contains(searchText.Trim(), StringComparison.OrdinalIgnoreCase));

    private string GetArtistName(int artistId) =>
        artists.FirstOrDefault(x => x.Id == artistId)?.Name ?? "Unknown";
}
