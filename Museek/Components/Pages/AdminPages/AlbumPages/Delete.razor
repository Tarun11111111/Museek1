@page "/albums/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@using Museek.Data
@inject IDbContextFactory<MuseekContext> DbFactory
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Delete Album</PageTitle>

@if (album == null)
{
    <div class="page">
        <p><em>Loading...</em></p>
    </div>
}
else
{
    <div class="page">
        <h1 class="page-title">Delete Album</h1>

        <div class="warning">
            <div class="warning-title">This will permanently delete this album.</div>
            <div class="warning-sub">Songs will not be deleted. Only the album and its album-song links.</div>
        </div>

        <div class="card">
            <div class="card-top">
                <img class="cover" src="@CoverSrc" alt="Album cover" />

                <div class="meta">
                    <div class="name">@album.Title</div>
                    <div class="desc">@((album.Description ?? "No description"))</div>

                    <div class="stats">
                        <div class="stat">
                            <div class="stat-num">@songCount</div>
                            <div class="stat-label">songs</div>
                        </div>

                        <div class="stat">
                            <div class="stat-num">@album.DateCreated.ToShortDateString()</div>
                            <div class="stat-label">created</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="actions">
                <a class="btn" href="@($"/albums/details?id={album.Id}")">Cancel</a>
                <button class="danger"
                        disabled="@isDeleting"
                        @onclick="DeleteAlbumAsync">
                    @(isDeleting ? "Deleting..." : "Delete Album")
                </button>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] private int Id { get; set; }

    private Album? album;
    private int songCount = 0;
    private bool isDeleting = false;

    private string CoverSrc =>
        !string.IsNullOrWhiteSpace(album?.Cover_Image)
            ? album!.Cover_Image!
            : "images/default-cover.jpg";

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        album = await db.Album.FirstOrDefaultAsync(a => a.Id == Id);
        if (album == null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        songCount = await db.AlbumSong.CountAsync(x => x.AlbumId == album.Id);
    }

    private async Task DeleteAlbumAsync()
    {
        if (album == null || isDeleting)
            return;

        isDeleting = true;

        using var db = DbFactory.CreateDbContext();

        var links = await db.AlbumSong.Where(x => x.AlbumId == album.Id).ToListAsync();
        if (links.Count > 0)
        {
            db.AlbumSong.RemoveRange(links);
        }

        db.Album.Remove(album);
        await db.SaveChangesAsync();

        NavigationManager.NavigateTo($"/albums?artistId={album.ArtistId}", forceLoad: false);
    }
}
