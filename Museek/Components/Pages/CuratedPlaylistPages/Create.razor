@page "/curatedplaylists/create"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@using Museek.Data
@using Microsoft.AspNetCore.Components.Forms
@using System.Security.Claims
@inject IDbContextFactory<MuseekContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Create Curated Playlist</PageTitle>

<div class="form-page">
    <h1 class="page-title">New Curated Playlist</h1>

    <EditForm Model="Playlist" OnValidSubmit="AddPlaylist">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="field">
            <label>Name</label>
            <InputText class="input" @bind-Value="Playlist.Name" />
        </div>

        <div class="field">
            <label>Description</label>
            <InputText class="input" @bind-Value="Playlist.Description" />
        </div>

        <div class="field">
            <label>Category</label>

            <div class="category-picker">
                <div class="category-top">
                    <input class="input category-input"
                           placeholder="Search or type a new category"
                           value="@categorySearch"
                           @oninput="OnCategoryInput" />

                    <button type="button"
                            class="cat-btn"
                            @onclick="UseTypedCategory"
                            disabled="@string.IsNullOrWhiteSpace(categorySearch)">
                        Use
                    </button>
                </div>

                <div class="category-list">
                    @if (FilteredCategories.Count == 0)
                    {
                        <div class="category-empty">
                            No categories found. Type above and click Use to create a new one.
                        </div>
                    }
                    else
                    {
                        @foreach (var c in FilteredCategories)
                        {
                            var isSelected = string.Equals(selectedCategory, c, StringComparison.OrdinalIgnoreCase);

                            <div class="category-row">
                                <div class="category-name">@c</div>

                                <button type="button"
                                        class="cat-pick @(isSelected ? "selected" : "")"
                                        @onclick="(() => SelectCategory(c))">
                                    @(isSelected ? "Selected" : "Select")
                                </button>
                            </div>
                        }
                    }
                </div>

                <div class="category-selected">
                    <div class="category-selected-label">Selected</div>
                    <input class="input category-selected-input"
                           value="@(selectedCategory ?? "")"
                           placeholder="No category selected"
                           disabled />
                    <button type="button"
                            class="cat-clear"
                            @onclick="ClearCategory"
                            disabled="@string.IsNullOrWhiteSpace(selectedCategory)">
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <div class="field">
            <label>Cover Image (optional)</label>

            <div class="cover-card">
                <div class="cover-thumb-wrap">
                    <img class="cover-thumb" src="@CoverPreviewSrc" alt="Cover preview" />
                </div>

                <div class="cover-right">
                    <InputFile OnChange="OnCoverSelected" accept="image/*" />
                    <div class="hint">PNG, JPG, WEBP. Max 5 MB.</div>

                    @if (!string.IsNullOrWhiteSpace(uploadError))
                    {
                        <div class="error">@uploadError</div>
                    }
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="primary" type="submit">Create</button>
            <a class="secondary" href="/curatedplaylists">Cancel</a>
        </div>
    </EditForm>
</div>

@code {
    private Playlist Playlist { get; set; } = new();

    private IBrowserFile? selectedCoverFile;
    private string? coverDataUrl;
    private string uploadError = "";

    private List<string> categories = new();
    private string categorySearch = "";
    private string? selectedCategory;

    private string CoverPreviewSrc =>
        !string.IsNullOrWhiteSpace(coverDataUrl) ? coverDataUrl : "images/default-cover.jpg";

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        var raw = await db.Playlist
            .AsNoTracking()
            .Where(p => p.IsCurated == true && p.IsPublic == true && p.CuratedCategory != null)
            .Select(p => p.CuratedCategory!)
            .ToListAsync();

        categories = raw
            .Select(NormalizeCategoryOrEmpty)
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(x => x)
            .ToList();
    }

    private List<string> FilteredCategories =>
        string.IsNullOrWhiteSpace(categorySearch)
            ? categories
            : categories
                .Where(c => c.Contains(categorySearch.Trim(), StringComparison.OrdinalIgnoreCase))
                .ToList();

    private void OnCategoryInput(ChangeEventArgs e)
    {
        categorySearch = e.Value?.ToString() ?? "";
    }

    private void SelectCategory(string c)
    {
        selectedCategory = c;
        categorySearch = c;
    }

    private void UseTypedCategory()
    {
        var normalized = NormalizeCategoryOrEmpty(categorySearch);
        if (string.IsNullOrWhiteSpace(normalized))
            return;

        selectedCategory = normalized;
        categorySearch = normalized;

        if (!categories.Contains(normalized, StringComparer.OrdinalIgnoreCase))
        {
            categories.Add(normalized);
            categories = categories.OrderBy(x => x).ToList();
        }
    }

    private void ClearCategory()
    {
        selectedCategory = null;
        categorySearch = "";
    }

    private async Task OnCoverSelected(InputFileChangeEventArgs e)
    {
        uploadError = "";
        selectedCoverFile = null;
        coverDataUrl = null;

        var file = e.File;
        if (file == null) return;

        const long maxBytes = 5 * 1024 * 1024;

        if (!file.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
        {
            uploadError = "Please choose an image file.";
            return;
        }

        if (file.Size > maxBytes)
        {
            uploadError = "Image is too large. Max 5 MB.";
            return;
        }

        selectedCoverFile = file;

        using var stream = file.OpenReadStream(maxAllowedSize: maxBytes);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var base64 = Convert.ToBase64String(ms.ToArray());
        coverDataUrl = $"data:{file.ContentType};base64,{base64}";
    }

    private async Task AddPlaylist()
    {
        using var db = DbFactory.CreateDbContext();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var currentUserId =
            user.FindFirst(ClaimTypes.NameIdentifier)?.Value
            ?? user.FindFirst("userId")?.Value
            ?? string.Empty;

        if (string.IsNullOrWhiteSpace(currentUserId))
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        if (selectedCoverFile != null)
        {
            var savedPath = await SaveCoverToWwwRootAsync(selectedCoverFile);
            if (!string.IsNullOrWhiteSpace(savedPath))
            {
                Playlist.Cover_Image = savedPath;
            }
        }

        Playlist.IsCurated = true;
        Playlist.IsPublic = true;

        var normalizedCategory = NormalizeCategoryOrNull(selectedCategory);
        Playlist.CuratedCategory = normalizedCategory;

        Playlist.UserId = currentUserId;
        Playlist.CreatedBy = currentUserId;
        Playlist.UpdatedBy = currentUserId;
        Playlist.DateCreated = DateTime.Now;
        Playlist.DateUpdated = DateTime.Now;

        db.Playlist.Add(Playlist);
        await db.SaveChangesAsync();

        NavigationManager.NavigateTo("/curatedplaylists", forceLoad: false);
    }

    private static string NormalizeCategoryOrEmpty(string? value)
    {
        var v = (value ?? "").Trim();
        return v;
    }

    private static string? NormalizeCategoryOrNull(string? value)
    {
        var v = (value ?? "").Trim();
        return string.IsNullOrWhiteSpace(v) ? null : v;
    }

    private static async Task<string> SaveCoverToWwwRootAsync(IBrowserFile file)
    {
        var ext = Path.GetExtension(file.Name);
        if (string.IsNullOrWhiteSpace(ext)) ext = ".png";

        var safeExt = ext.ToLowerInvariant();
        var allowed = new HashSet<string> { ".png", ".jpg", ".jpeg", ".webp" };
        if (!allowed.Contains(safeExt)) safeExt = ".png";

        var fileName = $"{Guid.NewGuid():N}{safeExt}";
        var folder = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "images", "playlists");
        Directory.CreateDirectory(folder);

        var absolutePath = Path.Combine(folder, fileName);

        const long maxBytes = 5 * 1024 * 1024;
        using var stream = file.OpenReadStream(maxAllowedSize: maxBytes);
        using var fs = File.Create(absolutePath);
        await stream.CopyToAsync(fs);

        return $"images/playlists/{fileName}";
    }
}
