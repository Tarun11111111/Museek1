@page "/ratings/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@using Museek.Data
@using System.ComponentModel.DataAnnotations
@inject IDbContextFactory<MuseekContext> DbFactory
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Edit Rating</PageTitle>

<div class="page">
    <div class="top">
        <div>
            <h1 class="title">Edit Rating</h1>
            <div class="subtitle">Update value and comment. Other fields are read-only.</div>
        </div>

        <div class="top-actions">
            @if (rating != null)
            {
                <a class="btn danger" href="@($"/ratings/delete?id={rating.Id}")">Delete</a>
            }
            <a class="btn" href="/ratings">Back</a>
        </div>
    </div>

    @if (loading)
    {
        <div class="card">
            <div class="muted">Loading...</div>
        </div>
    }
    else if (rating == null)
    {
        <div class="card">
            <div class="muted">Not found.</div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="song-card">
                <img class="song-cover" src="@songCover" alt="Cover" />
                <div class="song-card-meta">
                    <div class="song-title">@songTitle</div>
                    <div class="song-artist">@artistName</div>
                </div>
            </div>

            <div class="grid">
                <div class="field">
                    <div class="label">User ID</div>
                    <div class="value">@rating.UserId</div>
                </div>

                <div class="field">
                    <div class="label">Name</div>
                    <div class="value">@userName</div>
                </div>

                <div class="field">
                    <div class="label">Created</div>
                    <div class="value">@rating.DateCreated.ToString("dd MMM yyyy, HH:mm")</div>
                </div>

                <div class="field">
                    <div class="label">Updated</div>
                    <div class="value">@rating.DateUpdated.ToString("dd MMM yyyy, HH:mm")</div>
                </div>
            </div>

            <EditForm class="form" Model="form" OnValidSubmit="SaveAsync">
                <DataAnnotationsValidator />
                <ValidationSummary class="valsum" />

                <div class="form-row">
                    <label class="form-label">Rating</label>
                    <div class="star-row" role="radiogroup" aria-label="Rating">
                        @for (int i = 1; i <= 5; i++)
                        {
                            var starValue = i;
                            var on = form.Value >= starValue;

                            <button type="button"
                                    class="star-btn"
                                    aria-label="Set @starValue star"
                                    aria-pressed="@(on)"
                                    @onclick="@(() => SetValue(starValue))">
                                <span class="star @(on ? "on" : "off")">★</span>
                            </button>
                        }

                        <button type="button"
                                class="star-btn clear-btn"
                                aria-label="Clear rating"
                                @onclick="@(() => SetValue(0))">
                            <span class="clear-icon">×</span>
                        </button>
                    </div>

                    <div class="hint">@(form.Value == 0 ? "No rating" : $"{form.Value}/5")</div>
                    <ValidationMessage For="() => form.Value" class="valmsg" />
                </div>

                <div class="form-row">
                    <label class="form-label">Comment (optional)</label>
                    <textarea class="textarea" @bind="form.Comment" placeholder="Add some notes"></textarea>
                    <ValidationMessage For="() => form.Comment" class="valmsg" />
                </div>

                <div class="form-actions">
                    <button class="btn primary" type="submit" disabled="@saving">
                        @(saving ? "Saving..." : "Save")
                    </button>
                    <a class="btn" href="/ratings">Cancel</a>
                </div>
            </EditForm>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery] private int Id { get; set; }

    private bool loading = true;
    private bool saving = false;

    private Rating? rating;

    private string songTitle = "Unknown";
    private string songCover = "images/default-cover.png";
    private string artistName = "Unknown";

    private string userName = "Unknown";

    private EditRatingForm form = new();

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        rating = await db.Rating.FirstOrDefaultAsync(r => r.Id == Id);
        if (rating == null)
        {
            loading = false;
            NavigationManager.NavigateTo("notfound");
            return;
        }

        var song = await db.Song.FirstOrDefaultAsync(s => s.Id == rating.SongId);
        if (song != null)
        {
            songTitle = song.Title ?? "Unknown";
            songCover = string.IsNullOrWhiteSpace(song.Cover_Art) ? "images/default-cover.png" : song.Cover_Art;

            var artist = await db.Artist.FirstOrDefaultAsync(a => a.Id == song.ArtistId);
            artistName = artist?.Name ?? "Unknown";
        }

        try
        {
            var u = await db.Users
                .Where(x => x.Id == rating.UserId)
                .Select(x => new { x.UserName, x.Email, x.Id })
                .FirstOrDefaultAsync();

            if (u != null)
            {
                userName = !string.IsNullOrWhiteSpace(u.UserName) ? u.UserName
                    : !string.IsNullOrWhiteSpace(u.Email) ? u.Email
                    : u.Id;
            }
        }
        catch
        {
            userName = "Unknown";
        }

        form = new EditRatingForm
        {
            Value = rating.Value,
            Comment = rating.Comment ?? ""
        };

        loading = false;
    }

    private void SetValue(int v)
    {
        form.Value = v;
        StateHasChanged();
    }

    private async Task SaveAsync()
    {
        if (rating == null)
            return;

        saving = true;

        using var db = DbFactory.CreateDbContext();

        var entity = await db.Rating.FirstOrDefaultAsync(r => r.Id == rating.Id);
        if (entity == null)
        {
            saving = false;
            NavigationManager.NavigateTo("notfound");
            return;
        }

        entity.Value = form.Value;
        entity.Comment = string.IsNullOrWhiteSpace(form.Comment) ? null : form.Comment.Trim();
        entity.DateUpdated = DateTime.Now;

        await db.SaveChangesAsync();

        saving = false;
        NavigationManager.NavigateTo($"/ratings/details?id={entity.Id}");
    }

    private sealed class EditRatingForm
    {
        [Range(0, 5, ErrorMessage = "Rating must be between 0 and 5.")]
        public int Value { get; set; } = 0;

        public string? Comment { get; set; }
    }
}
