@page "/ratings/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Museek.Domain
@using Museek.Data
@inject IDbContextFactory<MuseekContext> DbFactory
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Delete Rating</PageTitle>

<div class="page">
    <div class="top">
        <div>
            <h1 class="title">Delete Rating</h1>
            <div class="subtitle">This action cannot be undone.</div>
        </div>

        <div class="top-actions">
            <a class="btn" href="/ratings">Back</a>
        </div>
    </div>

    @if (loading)
    {
        <div class="card">
            <div class="muted">Loading...</div>
        </div>
    }
    else if (rating == null)
    {
        <div class="card">
            <div class="muted">Not found.</div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="warn">
                Are you sure you want to delete this rating?
            </div>

            <div class="song-card">
                <img class="song-cover" src="@songCover" alt="Cover" />
                <div class="song-card-meta">
                    <div class="song-title">@songTitle</div>
                    <div class="song-artist">@artistName</div>
                </div>
            </div>

            <div class="grid">
                <div class="field">
                    <div class="label">User ID</div>
                    <div class="value">@rating.UserId</div>
                </div>

                <div class="field">
                    <div class="label">Name</div>
                    <div class="value">@userName</div>
                </div>

                <div class="field">
                    <div class="label">Rating</div>
                    <div class="stars" aria-label="@($"{rating.Value} out of 5")">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <span class="star @(i <= rating.Value ? "on" : "off")">★</span>
                        }
                    </div>
                    <div class="hint">@rating.Value/5</div>
                </div>

                <div class="field field-wide">
                    <div class="label">Comment</div>
                    @if (string.IsNullOrWhiteSpace(rating.Comment))
                    {
                        <div class="muted">No comment</div>
                    }
                    else
                    {
                        <div class="value">@rating.Comment</div>
                    }
                </div>

                <div class="field">
                    <div class="label">Updated</div>
                    <div class="value">@rating.DateUpdated.ToString("dd MMM yyyy, HH:mm")</div>
                    <div class="hint">By: @rating.UpdatedBy</div>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="error">@error</div>
            }

            <div class="actions">
                <button class="btn danger" type="button" @onclick="ConfirmDelete" disabled="@deleting">
                    @(deleting ? "Deleting..." : "Delete")
                </button>
                <a class="btn" href="/ratings">Cancel</a>
            </div>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery] private int Id { get; set; }

    private bool loading = true;
    private bool deleting = false;

    private Rating? rating;

    private string songTitle = "Unknown";
    private string songCover = "images/default-cover.png";
    private string artistName = "Unknown";

    private string userName = "Unknown";

    private string error = "";

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        rating = await db.Rating.FirstOrDefaultAsync(r => r.Id == Id);
        if (rating == null)
        {
            loading = false;
            NavigationManager.NavigateTo("notfound");
            return;
        }

        var song = await db.Song.FirstOrDefaultAsync(s => s.Id == rating.SongId);
        if (song != null)
        {
            songTitle = song.Title ?? "Unknown";
            songCover = string.IsNullOrWhiteSpace(song.Cover_Art) ? "images/default-cover.png" : song.Cover_Art;

            var artist = await db.Artist.FirstOrDefaultAsync(a => a.Id == song.ArtistId);
            artistName = artist?.Name ?? "Unknown";
        }

        try
        {
            var u = await db.Users
                .Where(x => x.Id == rating.UserId)
                .Select(x => new { x.UserName, x.Email, x.Id })
                .FirstOrDefaultAsync();

            if (u != null)
            {
                userName = !string.IsNullOrWhiteSpace(u.UserName) ? u.UserName
                    : !string.IsNullOrWhiteSpace(u.Email) ? u.Email
                    : u.Id;
            }
        }
        catch
        {
            userName = "Unknown";
        }

        loading = false;
    }

    private async Task ConfirmDelete()
    {
        if (rating == null)
            return;

        deleting = true;
        error = "";

        try
        {
            using var db = DbFactory.CreateDbContext();

            var entity = await db.Rating.FirstOrDefaultAsync(r => r.Id == rating.Id);
            if (entity == null)
            {
                deleting = false;
                NavigationManager.NavigateTo("notfound");
                return;
            }

            db.Rating.Remove(entity);
            await db.SaveChangesAsync();

            deleting = false;
            NavigationManager.NavigateTo("/ratings");
        }
        catch
        {
            deleting = false;
            error = "Delete failed. Please try again.";
        }
    }
}
