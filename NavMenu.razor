@implements IDisposable
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IServiceScopeFactory ScopeFactory
@using Microsoft.AspNetCore.Identity
@using Museek.Data



<div class="nav-wrapper">

    <!-- Left: Logo -->
    <div class="nav-left">
        <img src="images/MuseekLogo.png" class="logo-img" />
        <h1 class="logo-text">Museek</h1>
    </div>

    <AuthorizeView>
        <Authorized>
            <!-- Center: Navigation Links (logged in) -->
            <div class="nav-center">
                <NavLink href="/home" Match="NavLinkMatch.All">
                    <img src="images/homeIcon.png" class="icon" /> Home
                </NavLink>

                <AuthorizeView Roles="User" Context="UserCtx">
                    | <NavLink href="/userlibrary">
                        <img src="images/album.png" class="icon" /> Library
                    </NavLink>
                </AuthorizeView>

               @*  Need to add /usersongs for favorite songs *@

                <AuthorizeView Roles="Administrator" Context="adminCtx">
                    | <NavLink href="/curatedplaylists">
                        <img src="images/album.png" class="icon" /> Library
                    </NavLink>
                </AuthorizeView>

                <AuthorizeView Roles="User" Context="adminCtx">
                    | <NavLink href="/discover">
                        <img src="images/search.png" class="icon" /> Discover
                    </NavLink>
                </AuthorizeView>

                <AuthorizeView Roles="Administrator" Context="adminCtx">
                    | <NavLink href="/artists">
                        <img src="images/search.png" class="icon" /> Artists
                    </NavLink>
                </AuthorizeView>

                <AuthorizeView Roles="User" Context="UserCtx">
                    | <NavLink href="/usersongs/create">
                        <img src="images/upload.png" class="icon" /> All Songs
                    </NavLink>
                </AuthorizeView>

                <AuthorizeView Roles="Administrator" Context="adminCtx">
                    | <NavLink href="/songs">
                        <img src="images/upload.png" class="icon" /> Upload Music
                    </NavLink>
                </AuthorizeView>

                <AuthorizeView Roles="Administrator" Context="adminCtx">
                    | <NavLink href="/ratings">
                        <img src="images/dashboard.png" class="icon" /> Rating
                    </NavLink>
                </AuthorizeView>

            </div>

            <div class="nav-right">
                <div class="dropdown-wrapper">

                    <div class="user-trigger">
                        <img src="images/user.png" class="profile-icon" />
                        <span class="username-text">@firstName</span>
                        <span class="bi bi-caret-down-fill ms-1" style="font-size: 0.8rem;"></span>
                    </div>

                    <div class="dropdown-content">
                        <NavLink href="account" class="dropdown-item">
                            <span class="bi bi-person-gear me-2"></span> Account Details
                        </NavLink>

                        <NavLink href="userstats" class="dropdown-item">
                            <span class="bi bi-graph-up me-2"></span> User Statistics
                        </NavLink>

                        <hr class="dropdown-divider" />

                        <form action="Account/Logout" method="post">
                            <AntiforgeryToken />
                            <input type="hidden" name="ReturnUrl" value="" />
                            <button type="submit" class="dropdown-item text-danger">
                                <span class="bi bi-box-arrow-right me-2"></span> Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </Authorized>

        <NotAuthorized>
            <!-- Center: Navigation Links (not logged in) -->
            <div class="nav-center">
                <NavLink href="/home" Match="NavLinkMatch.All">
                    <img src="images/homeIcon.png" class="icon" /> Home
                </NavLink>

                <NavLink href="/discover">
                    <img src="images/search.png" class="icon" /> Discover
                </NavLink>
            </div>


        </NotAuthorized>
    </AuthorizeView>

</div>

@code {
    private string? firstName;
    private string? currentUrl;

    protected override async Task OnInitializedAsync()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        if (userPrincipal.Identity != null && userPrincipal.Identity.IsAuthenticated)
        {
            // FIX: Create a temporary "Scope" (a fresh connection) just for this block
            using (var scope = ScopeFactory.CreateScope())
            {
                // Get a fresh UserManager from the new scope
                var scopedUserManager = scope.ServiceProvider.GetRequiredService<UserManager<MuseekUser>>();

                var userInDb = await scopedUserManager.GetUserAsync(userPrincipal);

                if (userInDb != null)
                {
                    firstName = !string.IsNullOrEmpty(userInDb.FirstName)
                                ? userInDb.FirstName
                                : userPrincipal.Identity.Name;
                }
            }
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
<style>
    /* 1. Make sure the wrapper allows hovering */
    .dropdown-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
        padding-bottom: 20px; /* The invisible bridge */
        margin-bottom: -20px;
    }

    /* 2. Style the Name (Trigger) */
    .user-trigger {
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
        padding: 5px;
        border-radius: 4px;
    }

    .dropdown-wrapper:hover .user-trigger {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* 3. The Menu - FORCE it to hide/show */
    .dropdown-content {
        display: none; /* Hidden by default */
        position: absolute;
        right: 0;
        top: 100%;
        background-color: #1e1e1e; /* Dark background */
        min-width: 220px;
        box-shadow: 0px 4px 15px rgba(0,0,0,0.8);
        border: 1px solid #444;
        border-radius: 8px;
        z-index: 9999;
        padding: 8px 0;
    }

    /* 4. THE HOVER TRIGGER */
    .dropdown-wrapper:hover .dropdown-content {
        display: block !important; /* Force show on hover */
    }

    /* 5. The Links */
    .dropdown-item {
        color: #e0e0e0 !important; /* Force text to be light grey */
        padding: 12px 20px;
        text-decoration: none;
        display: block;
        transition: background 0.2s;
        font-size: 14px;
        width: 100%;
        background: transparent;
        border: none;
        text-align: left;
    }

        .dropdown-item:hover {
            background-color: #333;
            color: white !important;
        }

    .dropdown-divider {
        border-top: 1px solid #444;
        margin: 5px 0;
    }
</style>
